<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>WebGIS Catastro de Afectaciones por Desastres</title>
    <style type="text/css">
      body { overflow: hidden; }

      .navbar-offset { margin-top: 50px; }
      #map { position: absolute; top: 50px; bottom: 0px; left: 0px; right: 0px; }
      #map .ol-zoom { font-size: 1.2em; }

      .zoom-top-opened-sidebar { margin-top: 5px; }
      .zoom-top-collapsed { margin-top: 45px; }

      .mini-submenu{
        display:none;  
        background-color: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(0, 0, 0, 0.9);
        border-radius: 4px;
        padding: 9px;  
        width: 42px;
        text-align: center;
      }

      .mini-submenu-left {
        position: absolute;
        top: 60px;
        left: .5em;
        z-index: 40;
      }

      #map { z-index: 35; }

      .sidebar { z-index: 45; }

      .main-row { position: relative; top: 0; }

      .mini-submenu:hover{
        cursor: pointer;
      }

      .slide-submenu{
        background: rgba(0, 0, 0, 0.45);
        display: inline-block;
        padding: 0 8px;
        border-radius: 4px;
        cursor: pointer;
      }

      /* Leyenda integrada en el mapa - POSICIÓN CORREGIDA */
      #legend {
        background-color: rgba(255, 255, 255, 0.9);
        padding: 12px;
        position: absolute;
        bottom: 20px;
        right: 10px;
        border-radius: 5px;
        z-index: 1000;
        max-width: 220px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }

      .legend-color {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        border: 1px solid #333;
      }

      /* Estilos para filtros y estadísticas */
      #filters, #statistics {
        padding: 10px;
        margin: 10px 0;
        background-color: #f8f9fa;
        border-radius: 4px;
      }

      .filter-group {
        margin-bottom: 10px;
      }

      .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      .filter-group select, .filter-group input {
        width: 100%;
        padding: 5px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }

      .btn-kobo {
        background-color: #4CAF50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
      }

      .btn-kobo:hover {
        background-color: #45a049;
      }

      .stat-item {
        margin-bottom: 8px;
        padding: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        font-size: 14px;
      }

      .stat-value {
        font-weight: bold;
        color: #2c3e50;
      }

      .popup-content {
        max-width: 300px;
      }

      .popup-image {
        max-width: 100%;
        height: auto;
        margin: 5px 0;
      }

      .loading-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 5px;
        z-index: 1000;
        text-align: center;
      }
    </style>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script type="text/javascript">

      // Variables globales
      var map;
      var vectorSource;
      var vectorLayer;
      var geoJsonData = [];

      function applyMargins() {
        var leftToggler = $(".mini-submenu-left");
        if (leftToggler.is(":visible")) {
          $("#map .ol-zoom")
            .css("margin-left", 0)
            .removeClass("zoom-top-opened-sidebar")
            .addClass("zoom-top-collapsed");
        } else {
          $("#map .ol-zoom")
            .css("margin-left", $(".sidebar-left").width())
            .removeClass("zoom-top-opened-sidebar")
            .removeClass("zoom-top-collapsed");
        }
      }

      function isConstrained() {
        return $(".sidebar").width() == $(window).width();
      }

      function applyInitialUIState() {
        if (isConstrained()) {
          $(".sidebar-left .sidebar-body").fadeOut('slide');
          $('.mini-submenu-left').fadeIn();
        }
      }

      // Función para cargar datos GeoJSON
      function loadGeoJSONData() {
        // Mostrar mensaje de carga
        $('body').append('<div class="loading-message">Cargando datos de marejadas...</div>');
        
        return fetch('data/marejadas.geojson')
          .then(response => {
            if (!response.ok) {
              throw new Error('Error al cargar el archivo GeoJSON. Código: ' + response.status);
            }
            return response.json();
          })
          .then(data => {
            $('.loading-message').remove();
            if (!data.features || data.features.length === 0) {
              throw new Error('El archivo GeoJSON no contiene datos');
            }
            geoJsonData = data.features;
            console.log('Datos GeoJSON cargados:', geoJsonData.length, 'registros');
            return geoJsonData;
          })
          .catch(error => {
            $('.loading-message').remove();
            console.error('Error cargando GeoJSON:', error);
            // Crear un mensaje de error más informativo
            var errorMsg = 'Error al cargar los datos: ' + error.message + 
                          '. Verifica que el archivo data/marejadas.geojson exista y tenga el formato correcto.';
            alert(errorMsg);
            return []; // Retorna array vacío en lugar de datos de ejemplo
          });
      }

      // Función para mapear nivel_danio a urgencia
      function getUrgencyFromDamageLevel(nivelDanio) {
        switch(nivelDanio) {
          case "1": return "Bajo";
          case "2": return "Medio";
          case "3": return "Alto";
          default: return "Bajo";
        }
      }

      // Función para obtener color según urgencia
      function getColorByUrgency(urgency) {
        switch(urgency) {
          case 'Alto': return '#e74c3c';
          case 'Medio': return '#f39c12';
          case 'Bajo': return '#f1c40f';
          default: return '#95a5a6';
        }
      }

      // Función para crear estilo de puntos
      function createStyle(feature) {
        var urgency = feature.get('urgency');
        var color = getColorByUrgency(urgency);
        
        return new ol.style.Style({
          image: new ol.style.Circle({
            radius: 8,
            fill: new ol.style.Fill({color: color}),
            stroke: new ol.style.Stroke({
              color: '#2c3e50',
              width: 2
            })
          })
        });
      }

      // Función para crear contenido del popup
      function createPopupContent(feature) {
        var props = feature.getProperties();
        var content = `
          <div class="popup-content">
            <h5>Detalles del Reporte</h5>
            <p><strong>Tipo:</strong> ${props.tipo_afectacion || 'No especificado'}</p>
            <p><strong>Fecha:</strong> ${props.fecha_evento || 'No especificada'}</p>
            <p><strong>Nivel de daño:</strong> ${props.nivel_danio || 'No especificado'}</p>
            <p><strong>Altura agua:</strong> ${props.altura_agua || 'No especificado'} cm</p>
            <p><strong>Urgencia:</strong> <span style="color: ${getColorByUrgency(props.urgency)}">${props.urgency}</span></p>
            <p><strong>Comentarios:</strong> ${props.comentarios || 'Sin comentarios'}</p>
            <p><strong>Estado:</strong> ${props.estado_validacion || 'No especificado'}</p>
        `;
        
        if (props.foto_evento) {
          content += `<p><strong>Foto:</strong> ${props.foto_evento}</p>`;
        }
        
        content += `</div>`;
        return content;
      }

      // Función para aplicar filtros
      function applyFilters() {
        var typeFilter = $('#filter-type').val();
        var urgencyFilter = $('#filter-urgency').val();
        
        // Filtrar características
        var filteredFeatures = vectorSource.getFeatures().filter(function(feature) {
          var tipo = feature.get('tipo_afectacion');
          var urgencia = feature.get('urgency');
          
          var typeMatch = !typeFilter || tipo === typeFilter;
          var urgencyMatch = !urgencyFilter || urgencia === urgencyFilter;
          
          return typeMatch && urgencyMatch;
        });
        
        // Actualizar la fuente con características filtradas
        vectorSource.clear();
        vectorSource.addFeatures(filteredFeatures);
        
        // Actualizar estadísticas
        updateStatistics();
      }

      // Función para actualizar estadísticas
      function updateStatistics() {
        var features = vectorSource.getFeatures();
        var totalReports = features.length;
        
        var highUrgency = features.filter(f => f.get('urgency') === "Alto").length;
        var mediumUrgency = features.filter(f => f.get('urgency') === "Medio").length;
        var lowUrgency = features.filter(f => f.get('urgency') === "Bajo").length;
        
        var inundacionVereda = features.filter(f => f.get('tipo_afectacion') === "inundacion_vereda").length;
        var inundacionCalle = features.filter(f => f.get('tipo_afectacion') === "inundacion_calle").length;
        var inundacionVivienda = features.filter(f => f.get('tipo_afectacion') === "inundacion_vivienda").length;
        
        // Actualizar la interfaz
        $('#total-reports').text(totalReports);
        $('#high-urgency').text(highUrgency);
        $('#medium-urgency').text(mediumUrgency);
        $('#low-urgency').text(lowUrgency);
        $('#inundacion-vereda').text(inundacionVereda);
        $('#inundacion-calle').text(inundacionCalle);
        $('#inundacion-vivienda').text(inundacionVivienda);
      }

      // Función para inicializar el mapa con datos GeoJSON
      function initializeMapWithData(features) {
        if (features.length === 0) {
          alert('No hay datos para mostrar. El mapa se inicializará vacío.');
        }

        // Configuración del mapa
        map = new ol.Map({
          target: "map",
          layers: [
            new ol.layer.Tile({
              source: new ol.source.OSM()
            })
          ],
          view: new ol.View({
            center: ol.proj.fromLonLat([-71.626963, -33.038295]), // Centrado en tu dato
            zoom: 15
          })
        });

        // Crear fuente vectorial y capa
        vectorSource = new ol.source.Vector();
        vectorLayer = new ol.layer.Vector({
          source: vectorSource,
          style: createStyle
        });
        
        map.addLayer(vectorLayer);

        // Convertir características GeoJSON a características OpenLayers
        features.forEach(function(featureData) {
          var coords = featureData.geometry.coordinates;
          var props = featureData.properties;
          
          var feature = new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.fromLonLat([coords[0], coords[1]])),
            tipo_afectacion: props.tipo_afectacion,
            nivel_danio: props.nivel_danio,
            altura_agua: props.altura_agua,
            fecha_evento: props.fecha_evento,
            comentarios: props.comentarios,
            estado_validacion: props.estado_validacion,
            foto_evento: props.foto_evento,
            urgency: getUrgencyFromDamageLevel(props.nivel_danio)
          });
          
          vectorSource.addFeature(feature);
        });

        // Agregar interacción para popups
        var overlay = new ol.Overlay({
          element: document.createElement('div'),
          positioning: 'bottom-center',
          stopEvent: false
        });
        map.addOverlay(overlay);

        map.on('click', function(evt) {
          var feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
            return feature;
          });
          
          if (feature) {
            var content = createPopupContent(feature);
            overlay.getElement().innerHTML = content;
            overlay.setPosition(evt.coordinate);
          } else {
            overlay.setPosition(undefined);
          }
        });

        // Actualizar estadísticas iniciales
        updateStatistics();
      }

      $(function(){
        // Cargar datos GeoJSON primero
        loadGeoJSONData().then(function(features) {
          initializeMapWithData(features);
        });

        // Configuración del sidebar
        $('.sidebar-left .slide-submenu').on('click',function() {
          var thisEl = $(this);
          thisEl.closest('.sidebar-body').fadeOut('slide',function(){
            $('.mini-submenu-left').fadeIn();
            applyMargins();
          });
        });

        $('.mini-submenu-left').on('click',function() {
          var thisEl = $(this);
          $('.sidebar-left .sidebar-body').toggle('slide');
          thisEl.hide();
          applyMargins();
        });

        $(window).on("resize", applyMargins);

        // Configurar eventos de filtros
        $('#filter-form').on('submit', function(e) {
          e.preventDefault();
          applyFilters();
        });

        $('#reset-filters').on('click', function() {
          $('#filter-type').val('');
          $('#filter-urgency').val('');
          // Recargar todos los datos
          vectorSource.clear();
          loadGeoJSONData().then(function(features) {
            features.forEach(function(featureData) {
              var coords = featureData.geometry.coordinates;
              var props = featureData.properties;
              
              var feature = new ol.Feature({
                geometry: new ol.geom.Point(ol.proj.fromLonLat([coords[0], coords[1]])),
                tipo_afectacion: props.tipo_afectacion,
                nivel_danio: props.nivel_danio,
                altura_agua: props.altura_agua,
                fecha_evento: props.fecha_evento,
                comentarios: props.comentarios,
                estado_validacion: props.estado_validacion,
                foto_evento: props.foto_evento,
                urgency: getUrgencyFromDamageLevel(props.nivel_danio)
              });
              
              vectorSource.addFeature(feature);
            });
            updateStatistics();
          });
        });

        // Configurar botón de formulario Kobo
        $('#open-kobo-form').on('click', function() {
          window.open('https://ee.kobotoolbox.org/x/WpH0FcYu');
        });

        applyInitialUIState();
        applyMargins();
      });
    </script>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-fixed-top navbar-default" role="navigation">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">WebGIS - Catastro de Marejadas</a>
          </div>
          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
              <li class="active"><a href="#">Inicio</a></li>
              <li><a href="#">Acerca de</a></li>
              <li><a href="#">Contacto</a></li>
            </ul>
            <form class="navbar-form navbar-left" role="search">
              <div class="form-group">
                <input type="text" class="form-control" placeholder="Buscar ubicación...">
              </div>
              <button type="submit" class="btn btn-default">Buscar</button>
            </form>
            </div>
            </div>
          </nav>
        </div>
      
      <div class="navbar-offset"></div>
      <div id="map">
        <!-- Leyenda integrada en el mapa -->
        <div id="legend">
          <h4>Leyenda - Nivel de Urgencia</h4>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #e74c3c;"></div>
            <span>Alta Urgencia (Nivel 3)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #f39c12;"></div>
            <span>Media Urgencia (Nivel 2)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #f1c40f;"></div>
            <span>Baja Urgencia (Nivel 1)</span>
          </div>
        </div>
      </div>
      
      <div class="row main-row">
        <div class="col-sm-4 col-md-3 sidebar sidebar-left pull-left">
          <div class="panel-group sidebar-body" id="accordion-left" style="display: block;">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h4 class="panel-title">
                  <a data-toggle="collapse" href="#filters-panel">
                    <i class="fa fa-filter"></i>
                    Filtros
                  </a>
                  <span class="pull-right slide-submenu">
                    <i class="fa fa-chevron-left"></i>
                  </span>
                </h4>
              </div>
              <div id="filters-panel" class="panel-collapse collapse in">
                <div class="panel-body">
                  <form id="filter-form">
                    <div class="filter-group">
                      <label for="filter-type">Tipo de Afectación:</label>
                      <select id="filter-type">
                        <option value="">Todos</option>
                        <option value="inundacion_vereda">Inundación de Vereda</option>
                        <option value="inundacion_calle">Inundación de Calle</option>
                        <option value="inundacion_vivienda">Inundación de Vivienda</option>
                      </select>
                    </div>
                    
                    <div class="filter-group">
                      <label for="filter-urgency">Nivel de Urgencia:</label>
                      <select id="filter-urgency">
                        <option value="">Todos</option>
                        <option value="Alto">Alto</option>
                        <option value="Medio">Medio</option>
                        <option value="Bajo">Bajo</option>
                      </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">Aplicar Filtros</button>
                    <button type="button" id="reset-filters" class="btn btn-default btn-block" style="margin-top: 5px;">
                      Limpiar Filtros
                    </button>
                  </form>
                </div>
              </div>
            </div>
            
            <div class="panel panel-default">
              <div class="panel-heading">
                <h4 class="panel-title">
                  <a data-toggle="collapse" href="#statistics-panel">
                    <i class="fa fa-bar-chart"></i>
                    Estadísticas
                  </a>
                </h4>
              </div>
              <div id="statistics-panel" class="panel-collapse collapse in">
                <div class="panel-body">
                  <div class="stat-item">
                    <strong>Total de Reportes:</strong> <span id="total-reports" class="stat-value">0</span>
                  </div>
                  <div class="stat-item">
                    <strong>Alta Urgencia:</strong> <span id="high-urgency" class="stat-value">0</span>
                  </div>
                  <div class="stat-item">
                    <strong>Media Urgencia:</strong> <span id="medium-urgency" class="stat-value">0</span>
                  </div>
                  <div class="stat-item">
                    <strong>Baja Urgencia:</strong> <span id="low-urgency" class="stat-value">0</span>
                  </div>
                  <hr>
                  <div class="stat-item">
                    <strong>Inund. Vereda:</strong> <span id="inundacion-vereda" class="stat-value">0</span>
                  </div>
                  <div class="stat-item">
                    <strong>Inund. Calle:</strong> <span id="inundacion-calle" class="stat-value">0</span>
                  </div>
                  <div class="stat-item">
                    <strong>Inund. Vivienda:</strong> <span id="inundacion-vivienda" class="stat-value">0</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="panel panel-default">
              <div class="panel-heading">
                <h4 class="panel-title">
                  <a data-toggle="collapse" href="#kobo-panel">
                    <i class="fa fa-plus-circle"></i>
                    Realizar Reporte
                  </a>
                </h4>
              </div>
              <div id="kobo-panel" class="panel-collapse collapse in">
                <div class="panel-body">
                  <p>Para reportar una nueva afectación por marejadas:</p>
                  <button id="open-kobo-form" class="btn-kobo">Abrir Formulario Kobo</button>
                  <p style="font-size: 12px; margin-top: 10px; color: #666;">
                    El formulario se abrirá en una nueva ventana/tab.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="mini-submenu mini-submenu-left pull-left" style="display: none;">
        <i class="fa fa-bars"></i>
      </div>
    </div>
</body>
</html>